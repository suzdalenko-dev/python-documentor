-- expediente
SELECT V_CODIGO_ARTICULO,V_DESCRIPCION,V_CANTIDAD_ENTREGADA,V_PRESENTACION,V_PRECIO_PRESENTACION,V_DTO_1,V_DTO_2,V_DTO_3,V_IMPORTE_LIN_NETO,V_IMP_PORTES,V_CANTIDAD_FACTURADA,V_PRECIO_NETO,V_SERIE_PEDIDO,V_NUMERO_LOTE_INT,V_DESCRIPCION_LOTE,V_EXPEDIENTE_IMPORTACION,V_DESCRIPCION_LOTE2,V_CAMBIO,V_CENTRO_COSTE,V_NUMERO_PEDIDO,V_NUMERO_LINEA_PEDIDO,V_DEVOLUCION,V_UNIDADES_ALMACEN,V_UNIDAD_ALMACEN2,V_UNID_SUB,V_UNID_SOB,V_UNID_DIS,V_UNID_EXP,D_CENTRO_COSTE,V_DTO_4,V_DTO_5,V_DTO_6,V_IDTO_1,V_IDTO_2,V_IDTO_3,V_IDTO_4,V_IDTO_5,V_IDTO_6,V_DTOS_ACUMULADOS,CODIGO_EMPRESA,NUMERO_DOC_INTERNO,NUMERO_LINEA,ORG_COMPRAS_PEDIDO,ID_CRM,HAY_ASOCIACION_CRM,HAY_REPLICACION_VTA,HAY_TEXTOS FROM (SELECT ALBARAN_COMPRAS_L.* ,pkconsgen.f_descrip_centro_doc_albcmplin(codigo_empresa, numero_doc_interno, centro_coste) D_CENTRO_COSTE,pkconsgen.hay_asociacion_crm(codigo_empresa, id_crm) HAY_ASOCIACION_CRM,pkconsgen.hay_replicacion_com_vta(albaran_compras_l.numero_doc_interno, albaran_compras_l.codigo_empresa, albaran_compras_l.numero_linea) HAY_REPLICACION_VTA,pkconsgen.hay_textos_albcompra(codigo_empresa, numero_doc_interno, numero_linea) HAY_TEXTOS,CAMBIO V_CAMBIO,CANTIDAD_ENTREGADA V_CANTIDAD_ENTREGADA,NVL(CANTIDAD_FACTURADA, 0) V_CANTIDAD_FACTURADA,CENTRO_COSTE V_CENTRO_COSTE,CODIGO_ARTICULO V_CODIGO_ARTICULO,COALESCE(albaran_compras_l.descripcion,(SELECT a.descrip_comercial FROM articulos a WHERE a.codigo_articulo=albaran_compras_l.codigo_articulo AND a.codigo_empresa=albaran_compras_l.codigo_empresa)) V_DESCRIPCION,DECODE(albaran_compras_l.numero_lote_int,NULL,NULL,(SELECT lvhl.descripcion_lote FROM historico_lotes lvhl WHERE lvhl.numero_lote_int = albaran_compras_l.numero_lote_int AND lvhl.codigo_articulo = albaran_compras_l.codigo_articulo AND lvhl.codigo_empresa = albaran_compras_l.codigo_empresa)) V_DESCRIPCION_LOTE,DECODE(albaran_compras_l.numero_lote_int,NULL,NULL,(SELECT lvhl.descripcion_lote2 FROM historico_lotes lvhl WHERE lvhl.numero_lote_int = albaran_compras_l.numero_lote_int AND lvhl.codigo_articulo = albaran_compras_l.codigo_articulo AND lvhl.codigo_empresa = albaran_compras_l.codigo_empresa)) V_DESCRIPCION_LOTE2,pkconsgen.f_get_status_devolucion(codigo_empresa, numero_doc_interno, numero_linea, status) V_DEVOLUCION,dtos_acumulados V_DTOS_ACUMULADOS,dto_1 V_DTO_1,dto_2 V_DTO_2,dto_3 V_DTO_3,dto_4 V_DTO_4,dto_5 V_DTO_5,dto_6 V_DTO_6,dto_und V_DTO_UND,dto_und_cad V_DTO_UND_CAD,EXPEDIENTE_IMPORTACION V_EXPEDIENTE_IMPORTACION,idto_1 V_IDTO_1,idto_2 V_IDTO_2,idto_3 V_IDTO_3,idto_4 V_IDTO_4,idto_5 V_IDTO_5,idto_6 V_IDTO_6,idto_und V_IDTO_UND,idto_und_cad V_IDTO_UND_CAD,PKCONSGEN.IMPORTE(importe_lin_neto, importe_lin_neto_div, divisa, importe_lin_neto_div2) V_IMPORTE_LIN_NETO,PKCONSGEN.IMPORTE(NVL(importe_portes, 0), NVL(importe_portes_div, 0), divisa) V_IMP_PORTES,NUMERO_LINEA_PEDIDO V_NUMERO_LINEA_PEDIDO,COALESCE(numero_lote_int, pkconsgen.get_numero_lote_int_albcom(codigo_empresa, codigo_articulo, numero_doc_interno, numero_linea)) V_NUMERO_LOTE_INT,NUMERO_PEDIDO V_NUMERO_PEDIDO,PKCONSGEN.IMPORTE(precio_neto * cambio, precio_neto, divisa, precio_neto * cambio * cambio_div2) V_PRECIO_NETO,PKCONSGEN.IMPORTE(precio_presentacion * cambio, precio_presentacion, divisa, precio_presentacion * cambio * cambio_div2) V_PRECIO_PRESENTACION,PRESENTACION V_PRESENTACION,SERIE_PEDIDO V_SERIE_PEDIDO,UNIDADES_ALMACEN V_UNIDADES_ALMACEN,UNIDAD_ALMACEN2 V_UNIDAD_ALMACEN2,UNID_DIS V_UNID_DIS,UNID_EXP V_UNID_EXP,UNID_SOB V_UNID_SOB,UNID_SUB V_UNID_SUB FROM ALBARAN_COMPRAS_L) ALBARAN_COMPRAS_L WHERE (CODIGO_EMPRESA='001') and (NUMERO_DOC_INTERNO='2896');


-- albaran pendiente de facturar
SELECT V_FECHA,V_NUMERO_DOC_EXT,V_NUMERO_DOC_INTERNO,V_ORGANIZACION_COMPRAS,D_ORGANIZACION_COMPRAS,V_DEPOSITO,V_CENTRO_CONTABLE,D_CENTRO_CONTABLE,V_CODIGO_ALMACEN,D_CODIGO_ALMACEN,V_IMPORTE_TOTAL_ALBARAN,V_DIVISA,CODIGO_EMPRESA,NUMERO_DOC_INTERNO,ID_CRM,HAY_ASOCIACION_CRM,V_NUMERO_ASIENTO_BORRADOR,V_FECHA_ASIENTO,HAY_REPLICACION_VTA,V_NUMERO_EXPEDIENTE,V_HOJA_SEGUIMIENTO,V_USUARIO,V_CONTADOR_GESTION,STATUS_ANULADO,HAY_ARCHIVOS,V_TIPO_PEDIDO_COM,D_TIPO_PEDIDO_COM FROM (SELECT ALBARAN_COMPRAS_C.* ,(SELECT lvcc.nombre FROM caracteres_asiento lvcc WHERE lvcc.codigo = albaran_compras_c.centro_contable AND lvcc.empresa = albaran_compras_c.codigo_empresa) D_CENTRO_CONTABLE,(SELECT lval.nombre FROM almacenes lval WHERE lval.almacen = albaran_compras_c.codigo_almacen AND lval.codigo_empresa = albaran_compras_c.codigo_empresa) D_CODIGO_ALMACEN,(SELECT lvcpr.nombre FROM organizacion_compras lvcpr WHERE lvcpr.codigo_org_compras = albaran_compras_c.organizacion_compras AND lvcpr.codigo_empresa = albaran_compras_c.codigo_empresa) D_ORGANIZACION_COMPRAS,(SELECT lvtppco.descripcion FROM tipos_pedido_com lvtppco WHERE lvtppco.tipo_pedido = albaran_compras_c.tipo_pedido_com AND lvtppco.organizacion_compras = albaran_compras_c.organizacion_compras AND lvtppco.codigo_empresa = albaran_compras_c.codigo_empresa) D_TIPO_PEDIDO_COM,pkconsgen.ac_hay_archivos(codigo_empresa, numero_doc_interno) HAY_ARCHIVOS,pkconsgen.hay_asociacion_crm(codigo_empresa, id_crm) HAY_ASOCIACION_CRM,pkconsgen.hay_replicacion_com_vta(albaran_compras_c.numero_doc_interno, albaran_compras_c.codigo_empresa, NULL) HAY_REPLICACION_VTA,CENTRO_CONTABLE V_CENTRO_CONTABLE,CODIGO_ALMACEN V_CODIGO_ALMACEN,contador_gestion V_CONTADOR_GESTION,DECODE(deposito_proveedor, 'S', 'S', 'N', 'N', 'D', 'D', 'N') V_DEPOSITO,PKCONSGEN.DIVISA(PKCONSGEN.DIVISA_ALBARAN_COMPRAS(codigo_empresa, numero_doc_interno)) V_DIVISA,FECHA V_FECHA,fecha_asiento V_FECHA_ASIENTO,HOJA_SEGUIMIENTO V_HOJA_SEGUIMIENTO,PKCONSGEN.IMPORTE_TXT(PKCONSGEN.IMPORTE_ALBARAN_COMPRAS(codigo_empresa, numero_doc_interno, 'N'), PKCONSGEN.IMPORTE_ALBARAN_COMPRAS(codigo_empresa, numero_doc_interno, 'S'), PKCONSGEN.DIVISA_ALBARAN_COMPRAS(codigo_empresa, numero_doc_interno),PKCONSGEN.IMPORTE_ALBARAN_COMPRAS(codigo_empresa, numero_doc_interno, '2')) V_IMPORTE_TOTAL_ALBARAN,numero_asiento_borrador V_NUMERO_ASIENTO_BORRADOR,NUMERO_DOC_EXT V_NUMERO_DOC_EXT,NUMERO_DOC_INTERNO V_NUMERO_DOC_INTERNO,NUMERO_EXPEDIENTE V_NUMERO_EXPEDIENTE,ORGANIZACION_COMPRAS V_ORGANIZACION_COMPRAS,TIPO_PEDIDO_COM V_TIPO_PEDIDO_COM,USUARIO V_USUARIO FROM ALBARAN_COMPRAS_C) ALBARAN_COMPRAS_C WHERE codigo_proveedor = '000240' AND codigo_empresa = '001' AND NVL(deposito_proveedor, 'N') != 'S' AND facturado = 'N' AND interno = 'N'  order by FECHA DESC;

SELECT V_FECHA,
    V_NUMERO_DOC_EXT,
    V_NUMERO_DOC_INTERNO,
    V_CODIGO_ALMACEN,
    D_CODIGO_ALMACEN,
    V_IMPORTE_TOTAL_ALBARAN,
    V_DIVISA,
    NUMERO_DOC_INTERNO,
    V_NUMERO_EXPEDIENTE,
    V_HOJA_SEGUIMIENTO
    FROM (SELECT ALBARAN_COMPRAS_C.* ,(SELECT lvcc.nombre FROM caracteres_asiento lvcc WHERE lvcc.codigo = albaran_compras_c.centro_contable AND lvcc.empresa = albaran_compras_c.codigo_empresa) D_CENTRO_CONTABLE,(SELECT lval.nombre FROM almacenes lval WHERE lval.almacen = albaran_compras_c.codigo_almacen AND lval.codigo_empresa = albaran_compras_c.codigo_empresa) D_CODIGO_ALMACEN,(SELECT lvcpr.nombre FROM organizacion_compras lvcpr WHERE lvcpr.codigo_org_compras = albaran_compras_c.organizacion_compras AND lvcpr.codigo_empresa = albaran_compras_c.codigo_empresa) D_ORGANIZACION_COMPRAS,(SELECT lvtppco.descripcion FROM tipos_pedido_com lvtppco WHERE lvtppco.tipo_pedido = albaran_compras_c.tipo_pedido_com AND lvtppco.organizacion_compras = albaran_compras_c.organizacion_compras AND lvtppco.codigo_empresa = albaran_compras_c.codigo_empresa) D_TIPO_PEDIDO_COM,pkconsgen.ac_hay_archivos(codigo_empresa, numero_doc_interno) HAY_ARCHIVOS,pkconsgen.hay_asociacion_crm(codigo_empresa, id_crm) HAY_ASOCIACION_CRM,pkconsgen.hay_replicacion_com_vta(albaran_compras_c.numero_doc_interno, albaran_compras_c.codigo_empresa, NULL) HAY_REPLICACION_VTA,CENTRO_CONTABLE V_CENTRO_CONTABLE,CODIGO_ALMACEN V_CODIGO_ALMACEN,contador_gestion V_CONTADOR_GESTION,DECODE(deposito_proveedor, 'S', 'S', 'N', 'N', 'D', 'D', 'N') V_DEPOSITO,PKCONSGEN.DIVISA(PKCONSGEN.DIVISA_ALBARAN_COMPRAS(codigo_empresa, numero_doc_interno)) V_DIVISA,FECHA V_FECHA,fecha_asiento V_FECHA_ASIENTO,HOJA_SEGUIMIENTO V_HOJA_SEGUIMIENTO,PKCONSGEN.IMPORTE_TXT(PKCONSGEN.IMPORTE_ALBARAN_COMPRAS(codigo_empresa, numero_doc_interno, 'N'), PKCONSGEN.IMPORTE_ALBARAN_COMPRAS(codigo_empresa, numero_doc_interno, 'S'), PKCONSGEN.DIVISA_ALBARAN_COMPRAS(codigo_empresa, numero_doc_interno),PKCONSGEN.IMPORTE_ALBARAN_COMPRAS(codigo_empresa, numero_doc_interno, '2')) V_IMPORTE_TOTAL_ALBARAN,numero_asiento_borrador V_NUMERO_ASIENTO_BORRADOR,NUMERO_DOC_EXT V_NUMERO_DOC_EXT,NUMERO_DOC_INTERNO V_NUMERO_DOC_INTERNO,NUMERO_EXPEDIENTE V_NUMERO_EXPEDIENTE,ORGANIZACION_COMPRAS V_ORGANIZACION_COMPRAS,TIPO_PEDIDO_COM V_TIPO_PEDIDO_COM,USUARIO V_USUARIO FROM ALBARAN_COMPRAS_C) ALBARAN_COMPRAS_C 
    WHERE V_NUMERO_EXPEDIENTE = 84  AND codigo_empresa = '001' AND NVL(deposito_proveedor, 'N') != 'S' AND facturado = 'N' AND interno = 'N'  order by FECHA DESC;


-- cambio dentro de albaran (viene de la linea de albaran)
SELECT V_EXPEDIENTE_IMPORTACION,
    V_CAMBIO,V_DTO_4,
    NUMERO_DOC_INTERNO,
    NUMERO_LINEA 
    FROM (SELECT ALBARAN_COMPRAS_L.* ,pkconsgen.f_descrip_centro_doc_albcmplin(codigo_empresa, numero_doc_interno, centro_coste) D_CENTRO_COSTE,pkconsgen.hay_asociacion_crm(codigo_empresa, id_crm) HAY_ASOCIACION_CRM,pkconsgen.hay_replicacion_com_vta(albaran_compras_l.numero_doc_interno, albaran_compras_l.codigo_empresa, albaran_compras_l.numero_linea) HAY_REPLICACION_VTA,pkconsgen.hay_textos_albcompra(codigo_empresa, numero_doc_interno, numero_linea) HAY_TEXTOS,CAMBIO V_CAMBIO,CANTIDAD_ENTREGADA V_CANTIDAD_ENTREGADA,NVL(CANTIDAD_FACTURADA, 0) V_CANTIDAD_FACTURADA,CENTRO_COSTE V_CENTRO_COSTE,CODIGO_ARTICULO V_CODIGO_ARTICULO,COALESCE(albaran_compras_l.descripcion,(SELECT a.descrip_comercial FROM articulos a WHERE a.codigo_articulo=albaran_compras_l.codigo_articulo AND a.codigo_empresa=albaran_compras_l.codigo_empresa)) V_DESCRIPCION,DECODE(albaran_compras_l.numero_lote_int,NULL,NULL,(SELECT lvhl.descripcion_lote FROM historico_lotes lvhl WHERE lvhl.numero_lote_int = albaran_compras_l.numero_lote_int AND lvhl.codigo_articulo = albaran_compras_l.codigo_articulo AND lvhl.codigo_empresa = albaran_compras_l.codigo_empresa)) V_DESCRIPCION_LOTE,DECODE(albaran_compras_l.numero_lote_int,NULL,NULL,(SELECT lvhl.descripcion_lote2 FROM historico_lotes lvhl WHERE lvhl.numero_lote_int = albaran_compras_l.numero_lote_int AND lvhl.codigo_articulo = albaran_compras_l.codigo_articulo AND lvhl.codigo_empresa = albaran_compras_l.codigo_empresa)) V_DESCRIPCION_LOTE2,pkconsgen.f_get_status_devolucion(codigo_empresa, numero_doc_interno, numero_linea, status) V_DEVOLUCION,dtos_acumulados V_DTOS_ACUMULADOS,dto_1 V_DTO_1,dto_2 V_DTO_2,dto_3 V_DTO_3,dto_4 V_DTO_4,dto_5 V_DTO_5,dto_6 V_DTO_6,dto_und V_DTO_UND,dto_und_cad V_DTO_UND_CAD,EXPEDIENTE_IMPORTACION V_EXPEDIENTE_IMPORTACION,idto_1 V_IDTO_1,idto_2 V_IDTO_2,idto_3 V_IDTO_3,idto_4 V_IDTO_4,idto_5 V_IDTO_5,idto_6 V_IDTO_6,idto_und V_IDTO_UND,idto_und_cad V_IDTO_UND_CAD,PKCONSGEN.IMPORTE(importe_lin_neto, importe_lin_neto_div, divisa, importe_lin_neto_div2) V_IMPORTE_LIN_NETO,PKCONSGEN.IMPORTE(NVL(importe_portes, 0), NVL(importe_portes_div, 0), divisa) V_IMP_PORTES,NUMERO_LINEA_PEDIDO V_NUMERO_LINEA_PEDIDO,COALESCE(numero_lote_int, pkconsgen.get_numero_lote_int_albcom(codigo_empresa, codigo_articulo, numero_doc_interno, numero_linea)) V_NUMERO_LOTE_INT,NUMERO_PEDIDO V_NUMERO_PEDIDO,PKCONSGEN.IMPORTE(precio_neto * cambio, precio_neto, divisa, precio_neto * cambio * cambio_div2) V_PRECIO_NETO,PKCONSGEN.IMPORTE(precio_presentacion * cambio, precio_presentacion, divisa, precio_presentacion * cambio * cambio_div2) V_PRECIO_PRESENTACION,PRESENTACION V_PRESENTACION,SERIE_PEDIDO V_SERIE_PEDIDO,UNIDADES_ALMACEN V_UNIDADES_ALMACEN,UNIDAD_ALMACEN2 V_UNIDAD_ALMACEN2,UNID_DIS V_UNID_DIS,UNID_EXP V_UNID_EXP,UNID_SOB V_UNID_SOB,UNID_SUB V_UNID_SUB FROM ALBARAN_COMPRAS_L) ALBARAN_COMPRAS_L 
    WHERE (CODIGO_EMPRESA='001') and (NUMERO_DOC_INTERNO='2896');